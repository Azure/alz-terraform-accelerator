---
parameters:
  - name: serviceConnection
  - name: backendAzureResourceGroupName
  - name: backendAzureStorageAccountName
  - name: backendAzureStorageAccountContainerName
  - name: backendAzureStorageAccountContainerKeyName
    default: terraform.tfstate

steps:
  - task: AzureCLI@2
    displayName: 'Terraform Init'
    inputs:
      azureSubscription: $${{ parameters.serviceConnection }}
      scriptType: pscore
      scriptLocation: inlineScript
      addSpnToEnvironment: true
      inlineScript: |
        # Get settings from service connection
        az account show 2>$null | ConvertFrom-Json | Set-Variable account
        $clientId = $account.user.name
        $oidcToken ??= $env:idToken # requires addSpnToEnvironment: true
        $subscriptionId = $account.id
        $tenantId = $account.tenantId
        $authSpecificConfig = "-backend-config=`"client_id=$clientId`" -backend-config=`"oidc_token=$oidcToken`" -backend-config=`"use_oidc=true`""

        if($oidcToken -eq $null) {
          $authSpecificConfig = '-backend-config="use_msi=true"'
        }

        # Run terraform init
        terraform init -backend-config="storage_account_name=$($env:BACKEND_AZURE_STORAGE_ACCOUNT_NAME)" `
                       -backend-config="container_name=$($env:BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME)" `
                       -backend-config="key=$($env:BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_KEY_NAME)" `
                       -backend-config="resource_group_name=$($env:BACKEND_AZURE_RESOURCE_GROUP_NAME)" `
                       -backend-config="subscription_id=$subscriptionId" `
                       -backend-config="tenant_id=$tenantId" `
                       $authSpecificConfig

    env:
      ARM_USE_AZUREAD: true
      BACKEND_AZURE_RESOURCE_GROUP_NAME: $${{ parameters.backendAzureResourceGroupName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_NAME: $${{ parameters.backendAzureStorageAccountName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_NAME: $${{ parameters.backendAzureStorageAccountContainerName }}
      BACKEND_AZURE_STORAGE_ACCOUNT_CONTAINER_KEY_NAME: $${{ parameters.backendAzureStorageAccountContainerKeyName }}
