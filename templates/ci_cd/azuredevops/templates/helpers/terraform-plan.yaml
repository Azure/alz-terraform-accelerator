---
parameters:
  - name: terraform_action
    default: 'apply'
  - name: serviceConnection

steps:
  - task: AzureCLI@2
    displayName: Terraform Plan for $${{ coalesce(parameters.terraform_action, 'Apply') }}
    inputs:
      azureSubscription: $${{ parameters.serviceConnection }}
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        if ($env:TERRAFORM_ACTION -eq 'apply') {
          terraform plan -out=tfplan -input=false
        }
        if ($env:TERRAFORM_ACTION -eq 'destroy') {
          terraform plan -out=tfplan -input=false -destroy
        }
    env:
      ARM_USE_AZUREAD: true
      ARM_USE_CLI: true
      TERRAFORM_ACTION: $${{ coalesce(parameters.terraform_action, 'apply') }}
