resource "azurerm_container_group" "example" {
  for_each            = local.agents
  name                = each.value.name
  location            = var.location
  resource_group_name = azurerm_resource_group.agents.name
  ip_address_type     = "None"
  os_type             = "Linux"

  identity {
    type = "UserAssigned"
    identity_ids = [
      each.value.identity
    ]
  }

  container {
    name   = each.value.name
    image  = "jaredfholgate/azure-devops-agent:0.0.3"
    cpu    = "1"
    memory = "4"

    ports {
      port     = 80
      protocol = "TCP"
    }

    environment_variables = {
      AZP_URL            = "${var.azure_devops_organisation_prefix}/${var.azure_devops_organisation_target}"
      AZP_POOL           = each.value.pool
      AZP_AGENT_NAME     = each.value.name
      TARGET_ENVIRONMENT = each.value.environment
    }

    secure_environment_variables = {
      AZP_TOKEN = var.azure_devops_token
    }
  }
}